
@{

    if (!WebSecurity.IsAuthenticated)
   
        {
            Response.StatusCode=401;
            Response.End();
                   
        }      

    var PaylasimID=Request["PaylasimID"];
    var db=Database.Open("veritabani");
    
    List<Yorum> Yorumlar=new List<Yorum>();

    bool grupYoneticisiMi=false;

    if (db.QueryValue("SELECT count(*) FROM Grup_Paylasim WHERE GrupID IN (SELECT GrupID FROM Grup_Yonetici WHERE UserID=@1) AND PaylasimID=@0",PaylasimID,WebSecurity.CurrentUserId)>0)
    {
        grupYoneticisiMi=true;
    }

    var queryYorum=db.Query("SELECT * FROM Paylasim_Yorum INNER JOIN Profiles ON Paylasim_Yorum.UserID=Profiles.UserID WHERE Paylasim_Yorum.PaylasimID=@0 AND Paylasim_Yorum.Silindi=0",PaylasimID);

    foreach (var t in queryYorum)
    {
        Yorum y=new Yorum();
        y.Ad=t.ad;
        y.Soyad=t.soyad;
        y.Tarih=Tarih.TarihIslemleri_TarihGorunumu(t.Tarih);
        y.YorumMetni=t.Yorum;
        y.ID=t.ID;
        y.FotoURL=t.FotoURL;
        y.PaylasimID=t.PaylasimID;
        y.Onayli=t.Onayli;
        y.UserID=t.UserID; 
        if (t.UserID==WebSecurity.CurrentUserId || grupYoneticisiMi ) {y.SilmeIzni=1;}    
        
        Yorumlar.Add(y);
    }

    Json.Write(Yorumlar, Response.Output);
    db.Close();   
    Response.ContentType = "application/json";
    Response.End();

}

