
   @{
   
     if (!WebSecurity.IsAuthenticated)
   
        {
            Response.StatusCode=401;
            Response.End();
                   
        }  
         if (Request.Files.Count>0)
            {
                var db=Database.Open("veritabani");
                var GrupID=Request["GrupID"];
                var Dosya = Request.Files[0]; 
                WebImage imageDosya=null;
                imageDosya=WebImage.GetImageFromRequest();


                if (db.QueryValue("SELECT COUNT(*) FROM Grup_Yonetici WHERE GrupID=@0 AND UserID=@1",GrupID,WebSecurity.CurrentUserId)<1)
                {
                    db.Close();
                     Response.StatusCode=400;
                    Response.End();     
                }

                var KayitAdi=Guid.NewGuid().ToString();   
                var dosyaUzantisi = Dosya.FileName.Substring(Dosya.FileName.LastIndexOf('.')+1); 
                if (imageDosya.Width>300)
                {
                imageDosya.Resize(300,200,true);
                }
                imageDosya.Save(Server.MapPath("~/images/grupresimleri/" + KayitAdi + "." + dosyaUzantisi));
                db.Execute("UPDATE Grup SET Fotograf=@0 WHERE GrupID=@1",KayitAdi + "." + dosyaUzantisi,GrupID);
                Json.Write("OK", Response.Output);
                db.Close();   
                Response.ContentType = "application/json";
                Response.End();
                
            }
            else
            {
                Response.StatusCode=400;
                Response.End();                   
            }
  
}


