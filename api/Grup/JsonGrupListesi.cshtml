@{

if (!WebSecurity.IsAuthenticated)
    {
        Response.StatusCode = 401;
        Response.End();
        
    }
    var q=Request["sorgu"];
    var db=Database.Open("veritabani");
    var sorguIfadesi="";
    using (db)
    {
     if (string.IsNullOrEmpty(q))
     {
         sorguIfadesi="SELECT Grup.GrupURL, Grup.GrupID, Grup.GrupAdi,Grup.Aciklama,Profiles.FotoURL,(Profiles.ad + ' ' + Profiles.soyad) as adsoyad FROM Grup  INNER JOIN Profiles ON Grup.OlusturanKisi=Profiles.UserID WHERE Grup.GrupID NOT IN (SELECT GrupID FROM Grup_YasakliGrup)";
     }
     else
     {
          sorguIfadesi="SELECT Grup.GrupURL,Grup.GrupID,Grup.GrupAdi,Grup.Aciklama,Profiles.FotoURL,(Profiles.ad + ' ' + Profiles.soyad) as adsoyad FROM Grup INNER JOIN Profiles ON Grup.OlusturanKisi=Profiles.UserID WHERE (Grup.GrupAdi LIKE '" + q + "%'  OR Profiles.Ad LIKE '" + q + "%' OR Profiles.Soyad LIKE '" + q + "%') AND (Grup.GrupID NOT IN (SELECT GrupID FROM Grup_YasakliGrup))";
     }

    var sonuclar=db.Query(sorguIfadesi);
    Json.Write(sonuclar, Response.Output);
    db.Close();   
    Response.ContentType = "application/json";
    Response.End();
    
   }
}
