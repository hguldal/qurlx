@{

 if (!WebSecurity.IsAuthenticated)
    {
        Response.StatusCode = 401;
        Response.End();
            
            
    }   
   

    var GondericiID=WebSecurity.CurrentUserId;
    var Tarih=DateTime.Now;
    var Konu="";
    var Metin="";
    
    var MesajID=Request["MesajID"];
    var alicilarMetni=Request["txtKime"];
   
    string[] alicilar   = alicilarMetni.Split(',');

   
    using  (var db=Database.Open("veritabani"))
    {
    
        var queryIletilecekMesaj=db.QuerySingle("SELECT * FROM Mesaj WHERE MesajID=@0",MesajID);
        Konu=queryIletilecekMesaj.Konu;
        Metin=queryIletilecekMesaj.Metin;
        Tarih=queryIletilecekMesaj.Tarih;

        db.Execute("INSERT INTO Mesaj(GondericiID,Konu,Metin,Tarih) VALUES (@0,@1,@2,@3)",GondericiID,Konu,Metin,Tarih);

        var eklenenMesajID=db.GetLastInsertId();
    
        foreach (var item in alicilar)
           {
              db.Execute("INSERT INTO Mesaj_Gelen(UserID,MesajID) VALUES(@0,@1)",item,eklenenMesajID);
           }

         db.Execute("INSERT INTO Mesaj_Gonderilen(UserID,MesajID,GonderimTarihi) VALUES(@0,@1,@2)",WebSecurity.CurrentUserId,eklenenMesajID,DateTime.Now);
        
         var dosyaEkleri=db.Query("SELECT * FROM Mesaj_DosyaEki WHERE MesajID=@0",MesajID);

         foreach  (var dosyaEki in dosyaEkleri)  
         {
             db.Execute("INSERT INTO Mesaj_DosyaEki(MesajID,DosyaAdi,KayitAdi) VALUES(@0,@1,@2)",eklenenMesajID,dosyaEki.DosyaAdi,dosyaEki.KayitAdi);
         }
    

         db.Close();
         Response.Write("OK") ;
         Response.End();
     }

}


 