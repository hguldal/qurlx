
@{

 if (!WebSecurity.IsAuthenticated)
    {
        Response.StatusCode = 401;
        Response.End();
            
            
    }   
   
    var GondericiID=WebSecurity.CurrentUserId;
    var Tarih=DateTime.Now;
    var Konu=Request["txtKonu"];
    var Metin=Request["txtMetin"];
    var alicilarMetni=Request["txtKime"];
   
    string[] alicilar   = alicilarMetni.Split(',');

   
    using (var db=Database.Open("veritabani"))
    {
  
        db.Execute("INSERT INTO Mesaj(GondericiID,Konu,Metin,Tarih) VALUES (@0,@1,@2,@3)",GondericiID,Konu,Metin,Tarih);

       var mesajID=db.GetLastInsertId();
   
        foreach (var item in alicilar)
               {
                    db.Execute("INSERT INTO Mesaj_Gelen(UserID,MesajID) VALUES(@0,@1)",item,mesajID);
               }

        db.Execute("INSERT INTO Mesaj_Gonderilen(UserID,MesajID,GonderimTarihi) VALUES(@0,@1,@2)",WebSecurity.CurrentUserId,mesajID,DateTime.Now);
        
        
            if (Request.Files.Count>0)
            {
                var Dosya = Request.Files[0]; 
                var KayitAdi=Guid.NewGuid().ToString();     
                var dosyaUzantisi = Dosya.FileName.Substring(Dosya.FileName.LastIndexOf('.')+1); 
                Dosya.SaveAs(Server.MapPath("~/App_Data/Mesaj_DosyaEkleri/" + KayitAdi + "." + dosyaUzantisi));
                db.Execute("INSERT INTO Mesaj_DosyaEki(MesajID,KayitAdi,DosyaAdi) VALUES(@0,@1,@2)",mesajID,KayitAdi + "." + dosyaUzantisi, Dosya.FileName);
            }

             db.Close();
             Response.Write("OK") ;
             Response.End();
     }
    }


 
  
  