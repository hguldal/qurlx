@{
       var ad="";
        var soyad="";
        var FBID="";     
        var rEmail="";
     
        var db=Database.Open("veritabani");
        ad=Request.Form["txtAd"];
        soyad=Request.Form["txtSoyad"];
        FBID=Request.Form["txtFBID"];
        rEmail=Request.Form["txtEmail"];
        var email=FBID + "@facebook";
        var grupURL="fb" + FBID;
        var parola="Fb1285+$";
        // email adresi daha önce kullanılmış mı?
        if (db.QueryValue("SELECT COUNT(*) FROM Profiles WHERE Email=@0",email)!=0)
        {
           
           WebSecurity.Login(email,parola);
           Response.Write("OK");
           Response.End();
        }

       
        //Profile ekle

        db.Execute("INSERT INTO Profiles (Email,Ad,Soyad,Onayli,FacebookKullanicisi,FBEmail) VALUES (@0,@1,@2,@3,1,@4)",email,ad,soyad,0,rEmail);
        //üyelik oluştur
        var token= WebSecurity.CreateAccount(email,parola,false);
      
        Roles.AddUserToRole(email,"Standart");
        
         
        //Grup oluştur
        db.Execute("INSERT INTO Grup(GrupAdi,OlusturanKisi,OlusturmaTarihi,Gizlilik,UyeOnayTuru,Aciklama,KisiselGrup,GrupURL) VALUES (@0,@1,@2,@3,@4,@5,1,@6)",ad + " " + soyad + "'s Home Group ",WebSecurity.GetUserId(email),DateTime.Now,2,2,"",grupURL);

        //grubun ID sini al.
        var KurulanGrupID=db.GetLastInsertId();

      
        //gruba üye yap
        db.Execute("INSERT INTO Grup_Uye (GrupID,UserID,UyelikTarihi) VALUES (@0,@1,@2)",KurulanGrupID,WebSecurity.GetUserId(email),DateTime.Now);
        
        
        //gruba yönetici ata

        db.Execute("INSERT INTO Grup_Yonetici (GrupID,UserID,YoneticiOlmaTarihi) VALUES (@0,@1,@2)",KurulanGrupID,WebSecurity.GetUserId(email),DateTime.Now);
        db.Close();
       WebSecurity.Login(email,parola);
       
        Response.Write("OK");
                       
        Response.End();
}
