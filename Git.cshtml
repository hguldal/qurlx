@{
    var db=Database.Open("u2p");

    var erisimAnahtari=Request.QueryString["erisimAnahtari"];
    var kisaKod=Request.QueryString["kisaKod"];
    
    var erisimAcik=(db.QueryValue("SELECT COUNT(*) FROM ErisimAnahtari WHERE erisimAnahtari=@0 AND kisaKod=@1",erisimAnahtari,kisaKod)>0);
    
    //tek kullanımlık anahtarı sil
    db.Execute("DELETE FROM ErisimAnahtari WHERE erisimAnahtari=@0 AND kisaKod=@1",erisimAnahtari,kisaKod);
    
    var queryURL=db.QuerySingle("SELECT * FROM URL WHERE kisaKod=@0",kisaKod);
    var queryKategori=db.QuerySingle("SELECT * FROM Kategori WHERE kisakod=@0",kisaKod);

    //kod her iki nesnedede yoksa hata var ve tek neden olabilir verilen kod geçersiz
    if (queryURL==null && queryKategori==null)
    {
      db.Close();
      Response.Redirect("~/ErisimHatasi/AdresGecersiz");
    }


    if (queryURL!=null)
    {
        //istatistik
        Response.Redirect(queryURL.url);
    }

    db.Close();
}
