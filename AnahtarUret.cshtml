@{
    //bu sayfada, adreslere erişebilmek için tek kullanımlık anahtarlar üretir
    if (string.IsNullOrEmpty(Context.GetRouteValue("kod")))
     {
        Response.Write("Error !");
        Response.End();
        
     }
 
    var kod= Context.GetRouteValue("kod");
   
    var db=Database.Open("u2p");
    var queryUrl=db.QuerySingle("SELECT * FROM URL WHERE kisaKod=@0 OR uzunKod=@0",kod);
    var erisimAnahtari=Guid.NewGuid().ToString();

    db.Close();
    
    //url yok mu ? yoksa kategori olabilir mi ?
    if (queryUrl==null)
    {
       
       var queryKategori=db.QuerySingle("SELECT * FROM Kategori WHERE kisaKod=@0 OR uzunKod=@0",kod);
       
       if (queryKategori==null)
         {
             db.Close();
             Response.Redirect("~/ErisimHatasi/AdresGecersiz");//sistemde bu kodla kayıtlı bir url yada liste yok
         }
        
         //sistemde bu kodla kayıtlı bir kategori var
         else
         {
             //kategorinin sahibi oturum açmış kişi ise başka hiç bir koşula bakmaksızın direkt olarak adrese yönlendir.
             if (queryKategori.UserID==WebSecurity.CurrentUserId)
             {
                 
                 //anahtarı kaydet ve adrese yönlendir
                 db.Execute("INSERT INTO ErisimAnahtari(erisimAnahtari,kisaKod) VALUES(@0,@1)",erisimAnahtari,queryKategori.kisaKod);
                 db.Close();
                 Response.Redirect("~/Git?erisimAnahtari=" + erisimAnahtari + "&kisaKod=" + queryKategori.kisaKod);
             }

            
            //belirlenen erişim süreleri belirlenmiş mi ve bu süreler içerisinde mi?
            if (string.IsNullOrEmpty(queryKategori.erisimBaslamaTarihi)==false && string.IsNullOrEmpty(queryKategori.erisimBitisTarihi)==false )      
              {
                  if (queryKategori.erisimBaslamaTarihi<DateTime.Now || queryKategori.erisimBitisTarihi>DateTime.Now )
                    {
                        db.Close();
                        Response.Redirect("~/ErisimHatasi/ErisimeKapali");
                    }
              }

              //eğer adres herkese açık ise yine direkt olarak yönlendir.
              if (queryKategori.erisimTuru==1)
              {
                  //adrese yönlendir
                 db.Execute("INSERT INTO ErisimAnahtari(erisimAnahtari,kisaKod) VALUES(@0,@1)",erisimAnahtari,queryKategori.kisaKod);
                 db.Close();
                 Response.Redirect("~/Git?erisimAnahtari=" + erisimAnahtari + "&kisaKod=" + queryKategori.kisaKod);
              }
             
             
              //eğer adres üye olmayı gerektiriyorsa ve üye oturum açtı ise yine direkt olarak yönlendir.
              else if (queryKategori.erisimTuru==2)
              {
                  if (WebSecurity.IsAuthenticated)
                  {
                     db.Execute("INSERT INTO ErisimAnahtari(erisimAnahtari,kisaKod) VALUES(@0,@1)",erisimAnahtari,queryKategori.kisaKod);
                     db.Close();
                     Response.Redirect("~/Git?erisimAnahtari=" + erisimAnahtari + "&kisaKod=" + queryKategori.kisaKod);
                  }
                  else
                  {
                      db.Close();
                      Response.Redirect("~/ErisimHatasi/OturumAcmakGerekli");
                  }
              }
              
              //eğer adres sadece izin verilen kişilere açık ise 
              else if (queryKategori.erisimTuru==3)
              {
                      
                      if (db.QueryValue("SELECT COUNT(*) FROM KategoriErisimYetkisi WHERE kategoriID=@0 AND userID=@1",queryKategori.kategoriID,WebSecurity.CurrentUserId)>0)
                      {
                          //adrese yönlendir
                          db.Execute("INSERT INTO ErisimAnahtari(erisimAnahtari,kisaKod) VALUES(@0,@1)",erisimAnahtari,queryKategori.kisaKod);
                          db.Close();
                          Response.Redirect("~/Git?erisimAnahtari=" + erisimAnahtari + "&kisaKod=" + queryKategori.kisaKod);
                      }
                 
                      else
                      {
                         db.Close();
                         Response.Redirect("~/ErisimKodGirisi?kod=" + queryKategori.kisaKod);
                      }
                  
              }
              
              
              //eğer adres sadece sahibine açık ise oturum açan kişinin sahip olup olmadığını kontrol et.
              else if (queryKategori.erisimTuru==4)
              {
                     
                   db.Close();
                   Response.Redirect("~/ErisimHatasi/YetkinizYok");
                   
              }
         }
    
    }
    
    //url mevcut
    else
    {

            //url sahibi oturum açmış kişi ise başka hiç bir koşula bakmaksızın direkt olarak adrese yönlendir.
             if (db.QueryValue("SELECT COUNT(*) FROM URLYonetici WHERE urlID=@0 AND userID=@1",queryUrl.urlID,WebSecurity.CurrentUserId)>0)
             {
                 db.Execute("INSERT INTO ErisimAnahtari(erisimAnahtari,kisaKod) VALUES(@0,@1)",erisimAnahtari,queryUrl.kisaKod);
                 db.Close();
                 Response.Redirect("~/Git?erisimAnahtari=" + erisimAnahtari + "&kisaKod=" + queryUrl.kisaKod);
             }

            
            //belirlenen erişim süreleri belirlenmiş mi ve bu süreler içerisinde mi?
            if (string.IsNullOrEmpty(queryUrl.erisimBaslamaTarihi)==false && string.IsNullOrEmpty(queryUrl.erisimBitisTarihi)==false )      
              {
                  if (queryUrl.erisimBaslamaTarihi<DateTime.Now || queryUrl.erisimBitisTarihi>DateTime.Now )
                    {
                        db.Close();
                        Response.Redirect("~/ErisimHatasi/ErisimeKapali");
                    }
              }

              //eğer adres herkese açık ise yine direkt olarak yönlendir.
              if (queryUrl.erisimTuru==1)
              {
                  //adrese yönlendir
                 db.Execute("INSERT INTO ErisimAnahtari(erisimAnahtari,kisaKod) VALUES(@0,@1)",erisimAnahtari,queryUrl.kisaKod);
                 db.Close();
                 Response.Redirect("~/Git?erisimAnahtari=" + erisimAnahtari + "&kisaKod=" + queryUrl.kisaKod);
              }
             
             
              //eğer adres üye olmayı gerektiriyorsa ve üye oturum açtı ise yine direkt olarak yönlendir.
              else if (queryUrl.erisimTuru==2)
              {
                  if (WebSecurity.IsAuthenticated)
                  {
                      //adrese yönlendir
                       db.Execute("INSERT INTO ErisimAnahtari(erisimAnahtari,kisaKod) VALUES(@0,@1)",erisimAnahtari,queryUrl.kisaKod);
                         db.Close();
                         Response.Redirect("~/Git?erisimAnahtari=" + erisimAnahtari + "&kisaKod=" + queryUrl.kisaKod);
                  }
                  else
                  {
                      db.Close();
                      Response.Redirect("~/ErisimHatasi/OturumAcmakGerekli");
                  }
              }
              
              //eğer adres sadece izin verilen kişilere açık ise 
              else if (queryUrl.erisimTuru==3)
              {
                     
                      if (db.QueryValue("SELECT COUNT(*) FROM KategoriErisimYetkisi WHERE kategoriID=@0 AND userID=@1",queryUrl.urlID,WebSecurity.CurrentUserId)>0)
                      {
                           db.Execute("INSERT INTO ErisimAnahtari(erisimAnahtari,kisaKod) VALUES(@0,@1)",erisimAnahtari,queryUrl.kisaKod);
                             db.Close();
                             Response.Redirect("~/Git?erisimAnahtari=" + erisimAnahtari + "&kisaKod=" + queryUrl.kisaKod);
                      }
                 
                      else
                      {
                         db.Close();
                         Response.Redirect("~/ErisimKodGirisi?kod=" + queryUrl.kisaKod);
                      }
                  
              }
              
              
              //eğer adres sadece sahibine açık ise oturum açan kişinin sahip olup olmadığını kontrol et.
              else if (queryUrl.erisimTuru==4)
              {
                   db.Close();
                   Response.Redirect("~/ErisimHatasi/YetkinizYok");
              }

        
    }
    
    
}
