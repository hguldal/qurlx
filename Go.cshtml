@{
    var db=Database.Open("u2p");

    var erisimAnahtari=Request.QueryString["accessKey"];
    var kisaKod=Request.QueryString["code"];
   
   
    var queryURL=db.QuerySingle("SELECT * FROM URL WHERE kisaKod=@0",kisaKod);
     
    if (queryURL==null)
    {
      db.Close();
      Response.Redirect("~/Error/Invalid-Url");
    }


    else
    {
      var erisimAcik=(db.QueryValue("SELECT COUNT(*) FROM URLErisimAnahtari WHERE urlErisimAnahtari=@0 AND urlID=@1",erisimAnahtari,queryURL.urlID)>0);
      //tek kullanımlık anahtarı sil
      db.Execute("DELETE FROM URLErisimAnahtari WHERE urlErisimAnahtari=@0 AND urlID=@1",erisimAnahtari,queryURL.urlID);

      //ziyaretçi linke ilk kez mi tıklamış ?
     if (Request.Cookies[kisaKod]==null)
     {
            HttpCookie cerez=new HttpCookie(kisaKod);
            cerez.Expires=DateTime.UtcNow.AddHours(1);
            
            cerez.Value="";
         
            Response.Cookies.Add(cerez);
        
            db.Execute("INSERT INTO Ziyaret(urlID,userID,tarih,IP) VALUES(@0,@1,@2,@3)",queryURL.urlID,WebSecurity.CurrentUserId,DateTime.Now,Request.UserHostAddress);
     }

    else 
     
     {

         if (Request.Cookies[kisaKod].Expires>DateTime.UtcNow)
         {
             Request.Cookies[kisaKod].Expires=DateTime.UtcNow.AddHours(1);
             db.Execute("INSERT INTO Ziyaret(urlID,userID,tarih,IP) VALUES(@0,@1,@2,@3)",queryURL.urlID,WebSecurity.CurrentUserId,DateTime.Now,Request.UserHostAddress);
         }
         
     }
      
      //Response.Redirect(queryURL.url);
    }

    db.Close();
}
