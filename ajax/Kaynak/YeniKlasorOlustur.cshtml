@{
  if (!WebSecurity.IsAuthenticated)
   
        {
            Response.StatusCode=401;
            Response.End();
                   
        }  
        
     var db=Database.Open("u2p");
     var klasorKisaKod=Request["klasorKisaKod"];
     var klasorAdi=Request["klasorAdi"];
     var erisimTuru=Request["erisimTuru"];
     var klasorID=0;

     var yeniKlasorKisaKod=KodUret.YeniKod();
     //yeni klasörün oluşturulacağı yer
     var ustKlasorID=db.QueryValue("SELECT klasorID FROM Klasor WHERE kisaKod=@0",klasorKisaKod);
     
     using (db)
     {
         if (db.QueryValue("SELECT COUNT(*) FROM Klasor WHERE userID=@0 AND kisaKod=@1",WebSecurity.CurrentUserId,klasorKisaKod)>0)
         {
            while (db.QueryValue("SELECT COUNT(*) FROM KodCache WHERE kisaKod=@0",yeniKlasorKisaKod)>0)
            {
                yeniKlasorKisaKod=KodUret.YeniKod();
            }

            if (db.Execute("INSERT INTO KodCache(kisaKod) VALUES(@0)",yeniKlasorKisaKod)<1)
            {
                db.Close();
                Response.StatusCode=500;
                Response.End();
            }

            if (db.Execute("INSERT INTO Klasor(userID,klasorAdi,olusturmaTarihi,ustKlasorID,kisaKod,erisimTurID) VALUES(@0,@1,@2,@3,@4,@5)",WebSecurity.CurrentUserId,klasorAdi,DateTime.Now,ustKlasorID,yeniKlasorKisaKod,erisimTuru)<1)
            {
                 db.Close();
                 Response.StatusCode=500;
                 Response.End();
                   
            }

            var queryYeniOlusturulanKlasor=db.QuerySingle("SELECT klasorID as ogeID,1 as ogeTuru,klasorAdi as ogeAdi,olusturmaTarihi,kisaKod FROM Klasor WHERE kisaKod=@0",yeniKlasorKisaKod);

            Json.Write(queryYeniOlusturulanKlasor, Response.Output);
            db.Close();   
            Response.ContentType = "application/json";
            Response.End();

         }

         else 

         {
             
             db.Close();
             Response.StatusCode=401;
             Response.End();
         }
         
     }  

     db.Close();
}


